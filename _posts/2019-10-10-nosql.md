---
layout: posts
title:  "NoSQL" 
date:   2019-01-01 10:47:34 -0600
categories: nosql
---

Financial service providers are expected to available hundred percent of the time and expected to deliver up to date information. Expectations from a site like Ticketmaster are different, during peak hours site can make its users wait but when serving the information needs to be up to date. Social media sites are expected to be highly available but old data in the feed is tolerated. 

Relational databases like Oracle, MySQL, or Postgres can meet  expectations of consistency, availability and internal system failure tolerance by implementing  ACID principles. 

* Atomicity enables combining of multiple tasks which together complete an action into a single unit called transaction. Booking a seat also requires that a credit card be charged successfully.
* Consistency principle  ensures all tasks in a transaction are completed successfully. If one task from a set of tasks for a transaction fails, all successful changes are reverted and remaining abandoned. While this transaction is running no one else can make a contradicting change like double booking a seat. 
* While this seat is being booked the Isolation principle  ensures other visitors on the site see this seat as unavailable.
* The Durability principle will ensure completed transactions will be recorded even in the event of an external failure like network connectivity within the database subsystem. 

Consistency provided by an ACID databases comes at high cost and slow performance. The costs can get prohibitively large when the scale increases significantly. NoSQL databases  tradeoff between consistency and Availability to meet the needs at fraction of the cost. NoSQL databases are built on distributed computing principles in which a  cluster of nodes act as one unit with data distributed across multiple nodes for scale. This adds the requirement of Partition tolerance to Consistency and Availability.  Collectively know as the CAP theorem introduced by Eric Brewer

* Consistency: What you write is available for reading to all clients
* Availability: All clients are able to read and write data continuously
* Partition tolerance: Cluster can handle partial failures. 

Consider this use case: 

* You have a large dataset and choose to scale it by Sharding. Each shard will be on a different node with a partitioner controlling what is stored in each shard.
* Now if a network partition bring downs a shard the rest of the nodes can continue to operate without any interruption. But, the database is in a inconsistent state.
* To  keep reads requests working replicate the shards on different node. Resulting in a setup where  a node has shard for writes and replica of remaining shards for reads.
* Now if a Shard goes down reads can directed to one of the replicas. Writes continue to fail.
* NoSQL databases need to make a choice here between consistency and availability
* An consistency focused  database will block all read & write activity when a shard fails, designate a replica shard for writes and wait for all replicas to catchup before restarting writes.
* An availability focused NoSQL store will designate the most current replica shard as master and start accepting writes. The replicas become consistent eventually. Reads are not interrupted during this time. 

MongoDB is a popular CP database that has a primary node for writing, and data is made available on other nodes for reading. If the primary node fails, the cluster makes the secondary node with most up to date data as the primary node. The cluster remains unavailable  during this transfer to maintain consistency of writes. Availability is forfeited for consistency. Cassandra is an AP database that chooses eventual consistency to keep the database available for reads during node failure.


Choose NoSQL if you:    
Want to start fast,
need a flexible data model,
Scale to petabytes of data,
Want low latency, and,  
Can tradeoff between consistency and availability


References:
* https://static.googleusercontent.com/media/research.google.com/en//archive/bigtable-osdi06.pdf
* https://www.ibm.com/cloud/learn/cap-theorem
* https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed/
